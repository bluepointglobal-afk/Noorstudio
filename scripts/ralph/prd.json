{
  "project": "NoorStudio",
  "branchName": "ralph/pdf-epub-export",
  "description": "Implement PDF and EPUB export so users can download their finished books",
  "verifiers": [
    "npx tsc --noEmit"
  ],
  "stories": [
    {
      "id": "US-001",
      "title": "PDF Generation Service",
      "description": "As a developer, I want a PDF generation service so that books can be exported as PDF files.",
      "acceptanceCriteria": [
        "Create src/lib/export/pdfGenerator.ts",
        "Install and use jspdf library for browser-side PDF generation",
        "Accept LayoutArtifactContent and CoverArtifactContent as input",
        "Generate PDF with correct page dimensions based on trim size (6x9=432x648pt, 7x10=504x720pt, 8.5x11=612x792pt)",
        "Include front cover as first page",
        "Render text pages with proper fonts and margins",
        "Embed images (illustrations) at correct positions",
        "Include back cover as last page",
        "Return PDF as Blob",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "EPUB Generation Service",
      "description": "As a developer, I want an EPUB generation service so that books can be exported as EPUB files.",
      "acceptanceCriteria": [
        "Create src/lib/export/epubGenerator.ts",
        "Generate EPUB 3.0 compatible files using JSZip",
        "Create proper EPUB structure (META-INF/container.xml, OEBPS/, mimetype)",
        "Generate content.opf manifest with all resources",
        "Generate toc.ncx for navigation",
        "Convert chapters to XHTML format",
        "Embed images as base64 in XHTML or as separate files",
        "Include cover image in metadata",
        "Return EPUB as Blob",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Export Stage Runner",
      "description": "As a developer, I want the export stage integrated into stageRunner.ts so that it runs in the pipeline.",
      "acceptanceCriteria": [
        "Create runExportStage() function in stageRunner.ts",
        "Add 'export' to AIStageType union and isAIStage check",
        "Takes project with layout, cover, chapters, and illustrations artifacts",
        "Generates PDF and EPUB concurrently using Promise.all",
        "Shows progress during generation (0%, 50% PDF done, 100% EPUB done)",
        "Returns ExportArtifactContent with file metadata (format, fileSize, pageCount)",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Blob Download Utility",
      "description": "As a developer, I want a download utility so that users can download generated files.",
      "acceptanceCriteria": [
        "Create src/lib/export/downloadUtils.ts",
        "Implement downloadBlob(blob: Blob, filename: string) function",
        "Generate sanitized filenames from project title (remove special chars, replace spaces with hyphens)",
        "Support PDF (application/pdf) and EPUB (application/epub+zip) MIME types",
        "Trigger browser download dialog using URL.createObjectURL and anchor click",
        "Clean up object URL after download",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Export UI Integration",
      "description": "As an author, I want to export my book from the workspace so that I can download it.",
      "acceptanceCriteria": [
        "Update Export tab in ProjectWorkspacePage to show format selection (PDF, EPUB, Both)",
        "Show export button that triggers runExportStage()",
        "Show progress bar during generation with percentage",
        "Display download buttons when generation complete",
        "Show file sizes in human-readable format (KB, MB)",
        "Handle errors gracefully with toast messages",
        "Typecheck passes",
        "Verify in browser: can trigger export, see progress, download PDF and EPUB files"
      ],
      "priority": 5,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Export Caching and Stale Detection",
      "description": "As an author, I want export results cached and stale detection so that re-exports are fast.",
      "acceptanceCriteria": [
        "Cache generated Blobs in memory using Map keyed by project ID + format",
        "Store generation timestamp with each cached export",
        "Compare export timestamp with layout/cover/chapters artifact timestamps",
        "Show 'Regenerate' badge when source artifacts are newer than export",
        "Clear cache on project save or artifact regeneration",
        "Show 'Cached' indicator when serving from cache",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Export Index and Types",
      "description": "As a developer, I want proper exports and types so that the export module is well-organized.",
      "acceptanceCriteria": [
        "Create src/lib/export/index.ts with all exports",
        "Create src/lib/export/types.ts with ExportOptions, ExportResult interfaces",
        "Add export functions to src/lib/ai/index.ts",
        "Update ExportArtifactContent in artifacts.ts if needed",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": ""
    }
  ]
}
